<!DOCTYPE html>
<html>

    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frida and Objection</title>
<meta name="description" content="Security Researcher, Casual CTF Player, Located Melbourne Australia">

<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at http://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>R3zk0n</p>

    <ul class="pages">
      <li><a href="/"><i class="fa fa-home"></i> Home</a></li>
      <li><a href="/posts/"><i class="fa fa-archive"></i> All Posts</a></li>
      <li><a href="/search/"><i class="fa fa-search"></i> Search</a></li>
    </ul>

    <p class="links">
  <a href="https://www.twitter.com/Rezk0n" target="_new"><i class="fa fa-twitter"></i></a>
  
  
  
  
  <a href="https://github.com/R3zk0n" target="_new"><i class="fa fa-github-alt"></i></a>
  
  
  
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>


    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="http://schema.org/Article" class="col-md-12 article">
      
      <div class="thumb">
        <i class="fa fa-mobile fa-4x"></i>
      </div>
      

      <h1 class="header" itemprop="name">Frida and Objection</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">June 1, 2019</span>
           under Mobile
        </i></small>
      </div>

      <div class="read-time">
        <small>
          14 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h1 id="frida">Frida</h1>
<p>Frida is a Dynamic instrumentation toolkit for developers, reverse-engineers, and security researchers.</p>

<p>The Frida framework allows dymanic introspection of running applications and resources. It also has the ability to inject JavaScript in to a black box process, allowing you to hook functions, apis and trace senstive functions such as cryptograhpic API’s.</p>

<p>Frida uses <code class="highlighter-rouge">Gadget</code> to hook to the required processes. This is in either the form of a <code class="highlighter-rouge">.so</code> file or a <code class="highlighter-rouge">.dylib</code> file, for mobile devices.</p>

<h2 id="using-frida">Using Frida.</h2>
<p>To use frida, the device that is being targted must either have the frida-server installed on the device to allow communication to the device or a “Gadget” embedded in the application. There is two different methods for this.</p>

<h3 id="jailbroken-device---ios">Jailbroken Device - (iOS)</h3>

<h3 id="non-jailbroken-device---ios">Non Jailbroken Device - (iOS)</h3>

<h3 id="android-emulator---android">Android Emulator - (Android)</h3>
<p>I typically for most testing purposes use a <a href="https://www.genymotion.com/">Genymotion</a> emulator. These run on a x84 architure so uploading the arm version WILL NOT work. Instend there is a quiet simple process.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span>
<span class="s">""" This script aims to automate the process of starting frida-server
on an Android device (for now). The script is a part of AndroidTamer
project and is based on this issue:
https://github.com/AndroidTamer/Tools_Repository/issues/234.

This script performs following things:
1. Try to determine the device architecture
2. Download the frida-server and extract it
3. Push it to the device and execute it
4. Save the PID of the process and write it to 'frida.pid' file.

#Todo:
* Better exception handling.
* Implement better/robust architecture detection code
* Implement for more devices
* Implement the feature to kill frida-server afterwards
"""</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">backports</span> <span class="kn">import</span> <span class="n">lzma</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">frida</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">FRIDA_VERSION</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Frida not found. Please run `pip install frida` to proceed."</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">"c0dist@Garage4Hackers"</span>

<span class="c1"># Just put "adb" below, if adb exists in your system path.
</span><span class="n">adb_path</span> <span class="o">=</span> <span class="s">"adb"</span>

<span class="k">def</span> <span class="nf">device_exists</span><span class="p">():</span>
    <span class="s">""" This functions checks if any device is connected or not.
    """</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">'{} devices -l | grep -v "List of devices attached"'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
    <span class="c1"># We know shell=True is bad, but should be fine here.
</span>    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Found following device:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">get_device_arch</span><span class="p">():</span>
    <span class="s">""" This function tries to determine the architecture of the device, so that
    the correct version of Frida-server can be downloaded. The function, first,
    tries to get the output of `uname -m` and then it tries to matches it against
    some known values. If not, then it tries `getprop ro.product.cpu.abi`.

    This function is probably the weakest part of the code. If you know of more
    Arch names from uname output, please contribute.

    :returns either "arch" that Frida release page understands or None.
    """</span>
    <span class="n">arch</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">uname_cmd</span> <span class="o">=</span> <span class="s">"{} shell uname -m"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
    <span class="n">uname_archs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"i386"</span><span class="p">,</span> <span class="s">"i686"</span><span class="p">,</span> <span class="s">"arm64"</span><span class="p">,</span> <span class="s">"arm"</span><span class="p">,</span> <span class="s">"x86_64"</span><span class="p">]</span>
    <span class="c1"># We know shell=True is bad, but should be fine here.
</span>    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">uname_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">uname_archs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"i386"</span><span class="p">,</span> <span class="s">"i686"</span><span class="p">]:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="s">"x86"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">getprop_cmd</span> <span class="o">=</span> <span class="s">"{} shell getprop ro.product.cpu.abi"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
        <span class="n">getprop_archs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"armeabi"</span><span class="p">,</span> <span class="s">"armeabi-v7a"</span><span class="p">,</span> <span class="s">"arm64-v8a"</span><span class="p">,</span> <span class="s">"x86"</span><span class="p">,</span> <span class="s">"x86_64"</span><span class="p">]</span>
        <span class="c1"># We know shell=True is bad, but should be fine here.
</span>        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">getprop_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">getprop_archs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">in</span> <span class="p">[</span><span class="s">"armeabi"</span><span class="p">,</span> <span class="s">"armeabi-v7a"</span><span class="p">]:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="s">"x86"</span>
            <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s">"arm64-v8a"</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="s">"x86"</span>
            <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s">"x86"</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="s">"x86"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="n">output</span>
    <span class="k">return</span> <span class="n">arch</span>

<span class="k">def</span> <span class="nf">prepare_download_url</span><span class="p">(</span><span class="n">arch</span><span class="p">):</span>
    <span class="s">""" Depending upon the arch provided, the function returns the download URL.
    """</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s">"https://github.com/frida/frida/releases/download/{}/frida-server-{}-android-{}.xz"</span>
    <span class="k">return</span> <span class="n">base_url</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">FRIDA_VERSION</span><span class="p">,</span> <span class="n">FRIDA_VERSION</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">download_and_extract</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="s">""" This function downloads the given URL, extracts .xz archive
    as given file name.

    :returns True if successful, else False.
    """</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Downloading: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="c1"># Downloading and writing the archive.
</span>        <span class="n">archive_name</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s">".xz"</span>

        <span class="n">req</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">archive_name</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">lzma</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">archive_name</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[-] Error downloading frida-server."</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[-] Got HTTP status code {} from server."</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Writing file as: {}."</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">frida_server</span><span class="p">:</span>
            <span class="n">frida_server</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">push_and_execute</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="s">"""This function pushes the file to device, makes it executable,
    and then finally runs the binary. The function also saves the PID
    of process in 'frida.pid' file.
    """</span>
    <span class="n">push_cmd</span> <span class="o">=</span> <span class="s">"{} push {} /data/local/tmp/frida-server"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">chmod_cmd</span> <span class="o">=</span> <span class="s">"{} shell chmod 0755 /data/local/tmp/frida-server"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
    <span class="n">kill_cmd</span> <span class="o">=</span> <span class="s">"{} shell su 0 'killall frida-server'"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
    <span class="n">execute_cmd</span> <span class="o">=</span> <span class="s">"{} shell su 0 '/data/local/tmp/frida-server' &amp;"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>
    <span class="n">ps_cmd</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s shell 'su 0 ps' | grep frida-server | awk '{print $2}' &gt; frida.pid"</span> <span class="o">%</span> <span class="p">(</span><span class="n">adb_path</span><span class="p">)</span>

    <span class="n">status_code</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">push_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] File pushed to device successfully."</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">chmod_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">'frida.pid'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Killing all frida-server on device."</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">kill_cmd</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Executing frida-server on device."</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">execute_cmd</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Fetching the PID of frida-server and saving it to file."</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">ps_cmd</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[-] Could not push the binary to device."</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="s">""" This function is where the magic happens.
    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">device_exists</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"[-] No device found. Exiting."</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Current installed Frida version: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">FRIDA_VERSION</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Trying to determine device's arch."</span><span class="p">)</span>
    <span class="n">arch</span> <span class="o">=</span> <span class="n">get_device_arch</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">arch</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[+] Found arch: {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">arch</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">prepare_download_url</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s">"frida-server-{}-android-{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">FRIDA_VERSION</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">download_and_extract</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
            <span class="n">push_and_execute</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">[-] Could not determine device's arch. Exiting."</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure>

<p>There is a slight mod to the script which allows it to upload and detect the architure that the emulator is running and upload the file directory to the device using android debug bridge or <code class="highlighter-rouge">adb</code> for short.</p>

<p>##Non Rooted - (Android)</p>

<h3 id="tips">Tips:</h3>
<p>Set alias to route</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">frida_open</span><span class="o">=</span>frida-trace <span class="nt">-U</span> <span class="nt">-p</span> <span class="o">[</span>PID] <span class="s2">"Open*"</span></code></pre></figure>
<p>This allias will trace the open calls that frida uses.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">alias </span><span class="nv">frida_recv</span><span class="o">=</span>frida-trace <span class="nt">-U</span> <span class="nt">-p</span> <span class="o">[</span>PID] <span class="s2">"*recv"</span></code></pre></figure>
<p>This will track the recv function calls</p>

<p>###Tip:
<code class="highlighter-rouge">using wifi adb and adb connect &lt;deviceIP&gt;:5555</code> makes some debugging processes less of a hassle.</p>

<h1 id="objection">Objection</h1>

<p>Objection is a dynamic instruementation framework which heavily uses the frida framework.
Developed and maintained by <a href="www.github.com/leonza/sensepost">leonza</a></p>

<p>Can be downloaded here <a href="github.com/sensepost/objection">objection</a></p>

<h2 id="installing-objection">Installing Objection</h2>
<p>Installing objection is extremely simple as <code class="highlighter-rouge">pip3 install objection</code>. This will install objection and frida.</p>

<h2 id="method-hooking-objection">Method Hooking Objection.</h2>

<p>There are a number of functions and features objection has one such is the way Objection is able to dynmaically hook methods and backtrace allowing in runtime. This can allow a researcher to bypass jailbreak and root protections, aswell as a many of functions
<code class="highlighter-rouge">ios class list</code> will list all the avaiable classes.
[Picture of classes from DVIA]
Using the identifed classes we can look at the class methods and use objection to hook those and tamper with them
<code class="highlighter-rouge">ios class_method &lt;class&gt;</code> this command will then list the class methods assoicated to the previously identifed classes. 
[Pciture]
Now we have this class method that seems quite intersting
<code class="highlighter-rouge">-[DVWI IsJailBroken:]</code>
Now using the device we can see once wwe xx it returns 0x0 causing the applicaton to termiate, however we can overwrite this return value in two different ways, Objection at the moment only supports  could only set to</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">True <span class="o">=</span> <span class="sb">```</span>0x1<span class="sb">```</span> or False <span class="o">=</span> <span class="sb">```</span>0x0<span class="sb">```</span></code></pre></figure>

<h1 id="plugin-code">Plugin Code</h1>
<p>Writing plugin code for objection is extremely simple the code below, will enumerate the files listed in the directories and download them to the local enviorment.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">from</span> <span class="nn">objection.utils.plugin</span> <span class="kn">import</span> <span class="n">Plugin</span>
<span class="kn">from</span> <span class="nn">objection.commands.ios.hooking</span> <span class="kn">import</span> <span class="n">show_ios_classes</span><span class="p">,</span> <span class="n">show_ios_class_methods</span>
<span class="kn">from</span> <span class="nn">objection.commands.filemanager</span> <span class="kn">import</span> <span class="n">_ls_ios</span><span class="p">,</span> <span class="n">_get_short_ios_listing</span>
<span class="kn">from</span> <span class="nn">objection.commands.device</span> <span class="kn">import</span> <span class="n">_get_android_environment</span><span class="p">,</span> <span class="n">_get_ios_environment</span>
<span class="kn">from</span> <span class="nn">objection.state.connection</span> <span class="kn">import</span> <span class="n">state_connection</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="n">localpwd</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">'HOST'</span>

<span class="k">class</span> <span class="nc">FileList</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="s">""" Loads directoy's and files  """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="s">"""
            Creates a new instance of the plugin
            :param ns:
        """</span>

        <span class="c1"># self.script_path = os.path.join(os.path.dirname(__file__), "script.js")
</span>
        <span class="n">implementation</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meta'</span><span class="p">:</span> <span class="s">'Work with Frida file information'</span><span class="p">,</span>
            <span class="s">'commands'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'info'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">'meta'</span><span class="p">:</span> <span class="s">'Get the current file path'</span><span class="p">,</span>
                    <span class="s">'exec'</span><span class="p">:</span> <span class="n">Pentest_Suite</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">__file__</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">implementation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inject</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">Pentest_Suite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"Classes_dump.txt"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">state_connection</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
    <span class="n">env_path</span> <span class="o">=</span> <span class="n">state_connection</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span><span class="o">.</span><span class="n">env_ios_paths</span><span class="p">()</span>
    <span class="n">iOS_files</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">env_ios_paths</span><span class="p">()</span>
    <span class="n">api</span> <span class="o">=</span> <span class="n">state_connection</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
   <span class="c1"># for class_name in sorted(classes):
</span>    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iOS_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="n">val</span><span class="p">)</span>
        <span class="n">list_files</span> <span class="o">=</span> <span class="n">_ls_ios</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Path: "</span><span class="p">,</span> <span class="n">directories</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">list_files</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Not Mutable"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">glob_files</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">glob_files</span><span class="p">(</span><span class="n">directories</span><span class="p">):</span>
    <span class="c1"># IT seems likes anything we gotta do on the file system that isnt supported by frida uses Paramikko?.. fuck
</span>    <span class="n">plist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">directories</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"File Paths: "</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
    <span class="n">host_keys</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">load_system_host_keys</span><span class="p">()</span>
    <span class="c1"># Connect to our client; you will need
</span>    <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">'USERNAME'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'PASSWORD'</span><span class="p">)</span>
    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">'ls '</span><span class="o">+</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>





<span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">state_connection</span><span class="o">.</span><span class="n">get_api</span><span class="p">()</span>
    <span class="n">dir_files</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">env_android_paths</span><span class="p">()</span>
    <span class="n">download</span> <span class="o">=</span> <span class="n">_download_android</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">localpwd</span><span class="o">+</span><span class="s">'frida991356068dat'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dir_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s">":"</span><span class="o">+</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Not Iternationable item"</span><span class="p">)</span>


<span class="n">namespace</span> <span class="o">=</span> <span class="s">'Pentest_Suite'</span>
<span class="n">plugin</span> <span class="o">=</span> <span class="n">Pentest_Suite</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="err">#</span> <span class="nx">Frida</span> <span class="nx">Version</span> <span class="k">of</span> <span class="nx">bruteforce</span>

<span class="nx">use</span> <span class="nx">strict</span><span class="p">;</span>
    <span class="nx">interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(){</span>
        <span class="nl">onMatch</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
    <span class="p">}</span></code></pre></figure>

<h1 id="frida-objectivce-c-classes">Frida Objectivce C Classes.</h1>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">use</span> <span class="nx">strict</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">Objective</span><span class="p">.</span><span class="nx">C</span> <span class="nx">exists</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(){</span>
        <span class="nl">onMatch</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Matched: '</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

    <span class="p">}</span>
<span class="p">}</span>
<span class="s2">```</span></code></pre></figure>

<p>Using the scripts above and the use of HOPPER/IDA you can gather a quite a decent reverse enginning picture of the application, functions methods and use those to trace implementation features as such th following demostrates the use of Objection to Trace Certificate pinning issue and set the return value</p>
<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="mh">0x1</span></code></pre></figure>
<p>or</p>
<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="mh">0x0</span></code></pre></figure>

</span>

        

        

        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            mobile, hacking, penetration testing
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="http://www.twitter.com/Rezk0n">@Rezk0n</a>!
      </div>
      

      

      

    </div>

  </div>

</div>



      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-6">
    
  </div>
  <div class="col-md-6">
    
  </div>
</div>

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>




<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '']);
          _gaq.push(['_trackPageview']);
  (function () {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';

      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
  })();
</script>



    </body>
</html>
